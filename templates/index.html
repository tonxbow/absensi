<!DOCTYPE html>
<html>
<head>
    <title>Network Config</title>
    <style>
        body { font-family: Arial; background: #f4f4f4; margin: 0; padding: 0; }
        .container { width: 800px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; }
        h2 { background: #007BFF; color: white; padding: 10px; border-radius: 5px; }
        form { margin-bottom: 20px; }
        label { display: block; margin-top: 10px; }
        input, select { width: 100%; padding: 8px; margin-top: 5px; }
        button { background: #007BFF; color: white; border: none; padding: 10px; margin-top: 10px; cursor: pointer; }
        .status { padding: 10px; background: #eee; margin-bottom: 20px; border-radius: 5px; }
        .flash { background: #d4edda; padding: 10px; margin-bottom: 10px; border: 1px solid #c3e6cb; border-radius: 5px; }
    </style>
</head>
<body>
<div class="container">
    {% with messages = get_flashed_messages() %}
    {% if messages %}
        {% for msg in messages %}
            <div class="flash">{{ msg }}</div>
        {% endfor %}
    {% endif %}
    {% endwith %}

    <div class="status">
        <b>Ethernet IP:</b> {{ eth_ip or '—' }} |
        <b>WiFi IP:</b> {{ wlan_ip or '—' }}
    </div>

    <h2>Ethernet</h2>
    <form method="post" action="{{ url_for('save_ethernet') }}">
        <label>Mode:</label>
        <select name="ethernet_mode">
            <option value="dhcp" {% if ethernet_cfg and ethernet_cfg.mode == 'dhcp' %}selected{% endif %}>DHCP</option>
            <option value="manual" {% if ethernet_cfg and ethernet_cfg.mode == 'manual' %}selected{% endif %}>Static</option>
        </select>
        <label>IP Address:</label>
        <input type="text" name="ip" value="{{ ethernet_cfg.ip if ethernet_cfg and ethernet_cfg.mode == 'manual' else '' }}">
        <label>Subnet Mask:</label>
        <input type="text" name="subnet" value="{{ ethernet_cfg.subnet if ethernet_cfg and ethernet_cfg.mode == 'manual' else '' }}">
        <label>Gateway:</label>
        <input type="text" name="gateway" value="{{ ethernet_cfg.gateway if ethernet_cfg and ethernet_cfg.mode == 'manual' else '' }}">
        <button type="submit">Save Ethernet</button>
    </form>

    <h2>WiFi</h2>
    <form method="post" action="{{ url_for('save_wifi') }}">
        <label>SSID:</label>
        <input type="text" name="ssid" id="ssid-input" list="ssid-list" value="{{ wifi_cfg.ssid if wifi_cfg else '' }}">
        <datalist id="ssid-list">
            {% if wifi_cfg %}
                <option value="{{ wifi_cfg.ssid }}">
            {% endif %}
        </datalist>
        <button type="button" onclick="refreshSSID()">Refresh SSID</button>
        <label>Password:</label>
        <input type="password" name="password" value="{{ wifi_cfg.password if wifi_cfg else '' }}">
        <button type="submit">Save WiFi</button>
    </form>

    <h2>Device Info</h2>
    <form method="post" action="{{ url_for('save_device') }}">
        <label>Machine ID:</label>
        <input type="text" name="machine_id" value="{{ cfg['machine-id'] if 'machine-id' in cfg else '' }}">
        <label>API Host:</label>
        <input type="text" name="api_host" value="{{ cfg['api-server'] if 'api-server' in cfg else '' }}">
        <button type="submit">Save Device Info</button>
    </form>

    <h2>Timezone</h2>
    <form method="post" action="{{ url_for('save_timezone') }}">
        <label>Timezone:</label>
        <select name="timezone">
            <option value="UTC" {% if timezone == 'UTC' %}selected{% endif %}>UTC (GMT+0)</option>
            <option value="GMT" {% if timezone == 'GMT' %}selected{% endif %}>GMT</option>
            <option value="Europe/London" {% if timezone == 'Europe/London' %}selected{% endif %}>Europe/London (GMT/BST)</option>
            <option value="Asia/Jakarta" {% if timezone == 'Asia/Jakarta' %}selected{% endif %}>Asia/Jakarta (GMT+7)</option>
            <option value="Asia/Bangkok" {% if timezone == 'Asia/Bangkok' %}selected{% endif %}>Asia/Bangkok (GMT+7)</option>
            <option value="Asia/Shanghai" {% if timezone == 'Asia/Shanghai' %}selected{% endif %}>Asia/Shanghai (GMT+8)</option>
            <option value="Asia/Tokyo" {% if timezone == 'Asia/Tokyo' %}selected{% endif %}>Asia/Tokyo (GMT+9)</option>
            <option value="Australia/Sydney" {% if timezone == 'Australia/Sydney' %}selected{% endif %}>Australia/Sydney (GMT+10)</option>
            <option value="Pacific/Auckland" {% if timezone == 'Pacific/Auckland' %}selected{% endif %}>Pacific/Auckland (GMT+12)</option>
            <option value="America/New_York" {% if timezone == 'America/New_York' %}selected{% endif %}>America/New_York (GMT-5)</option>
            <option value="America/Los_Angeles" {% if timezone == 'America/Los_Angeles' %}selected{% endif %}>America/Los_Angeles (GMT-8)</option>
        </select>
        <button type="submit">Save Timezone</button>
    </form>

    <h2>QR Code Scanner</h2>
    <form method="post" action="{{ url_for('save_qr_device') }}">
        <label>QR Scanner Device:</label>
        <select name="qr_device" id="qr-device-select">
            <option value="none" {% if not qr_cfg or not qr_cfg.enabled %}selected{% endif %}>No QR Scanner</option>
            {% for device in usb_devices %}
                <option value="{{ device.id }}" 
                    {% if qr_cfg and qr_cfg.enabled and qr_cfg.device_id == device.id %}selected{% endif %}>
                    {{ device.name }} ({{ device.id }})
                </option>
            {% endfor %}
        </select>
        <button type="button" onclick="refreshUSBDevices()">Refresh USB Devices</button>
        <div style="margin-top: 10px; font-size: 12px; color: #666;">
            Current: {{ qr_cfg.device_name if qr_cfg else 'No QR Scanner' }}
        </div>
        <button type="submit">Save QR Scanner</button>
    </form>
    <form method="post" action="{{ url_for('restart_app') }}">
        <button style="width: 100%; background-color: red;" class="danger" type="submit">RESTART APPLICATION</button>
    </form>
</div>

<script>
function refreshSSID(){
    fetch('/scan_ssid')
    .then(res => res.json())
    .then(data => {
        let datalist = document.getElementById('ssid-list');
        datalist.innerHTML = '';
        data.forEach(ssid => {
            let opt = document.createElement('option');
            opt.value = ssid;
            datalist.appendChild(opt);
        });
    });
}

function refreshUSBDevices(){
    fetch('/scan_usb_devices')
    .then(res => res.json())
    .then(data => {
        let select = document.getElementById('qr-device-select');
        let currentValue = select.value;
        
        // Clear all options except "No QR Scanner"
        select.innerHTML = '<option value="none">No QR Scanner</option>';
        
        // Add new devices
        data.forEach(device => {
            let opt = document.createElement('option');
            opt.value = device.id;
            opt.textContent = `${device.name} (${device.id})`;
            select.appendChild(opt);
        });
        
        // Try to restore previous selection
        if (currentValue !== 'none') {
            let found = false;
            for (let option of select.options) {
                if (option.value === currentValue) {
                    option.selected = true;
                    found = true;
                    break;
                }
            }
            if (!found) {
                select.value = 'none';
            }
        }
    })
    .catch(err => {
        console.error('Error refreshing USB devices:', err);
        alert('Failed to refresh USB devices');
    });
}
</script>
</body>
</html>
